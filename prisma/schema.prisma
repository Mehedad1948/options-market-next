generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// 1. SIGNAL DATA (Existing Logic)
// --------------------------------------------------------

model TalebSignal {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())

    marketStatus String? // e.g. "OPEN", "CLOSED"

    aiReasoning String  @db.Text
    
    // Structured advice from the AI
    callAdvice  Json?
    putAdvice   Json?

    // Full list of filtered candidates
    candidates Json

    // Global flag: Did we send this to AT LEAST the admin?
    sentNotification Boolean @default(false) 
}

// --------------------------------------------------------
// 2. USER & AUTHENTICATION
// --------------------------------------------------------

model User {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // -- Identity --
    // We make these unique so one Telegram account = one User
    telegramId  String? @unique 
    phoneNumber String? @unique 
    email       String? @unique
    
    // Optional display name (e.g. from Telegram first_name)
    firstName   String?
    lastName    String?

    // -- Role Management --
    role        UserRole @default(USER)

    // -- Subscription Logic --
    // If this date is in the future -> User is Premium/Subscribed
    // If null or past -> User is Free/Expired
    subscriptionExpiresAt DateTime?

    // -- Notification Preferences --
    // Users can toggle these in their settings
    notifyTelegram Boolean @default(true)
    notifyWeb      Boolean @default(true)
    
    // Relation to OTPs (Optional, but good for cleanup)
    otps Otp[]
}

// --------------------------------------------------------
// 3. SECURITY (OTP)
// --------------------------------------------------------

model Otp {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    
    // The identifier the code was sent to (TelegramID, Phone, or Email)
    identifier String
    
    // The actual code (e.g., "12345")
    code       String
    
    // When the code expires (e.g., 5 minutes from now)
    expiresAt  DateTime
    
    // Is this for Telegram, SMS, or Email?
    type       OtpType

    // If the user already exists, link it (optional)
    userId     String?
    user       User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --------------------------------------------------------
// ENUMS
// --------------------------------------------------------

enum UserRole {
    USER
    ADMIN
}

enum OtpType {
    TELEGRAM
    SMS
    EMAIL
}
